from PIL import Image
import os
import shutil


class Photo:
    """
    init a png file for fm players.
    """
    def __init__(self, name, path, width=0, height=0):
        self.id_ = name[:-4]
        self.name = name
        self.path = path
        self.real_dir = os.path.join(path, name)
        if width != 0:
            with Image.open(self.real_dir) as img:
                self.width, self.height = img.size
        else:
            self.width = width
            self.height = height

    def __repr__(self):
        return self.name

    def move(self, new_real_dir):
        """
        move current photo to another folder.
        """
        shutil.move(self.real_dir, new_real_dir)
        self.real_dir = new_real_dir

    def __eq__(self, other):
        if self.id_ == other.id:
            return self.width == other.width and self.height == other.height


class Folder:
    """
    init a folder contains fm players' photo.
    """
    def __init__(self, path):
        self.path = path
        self.name = os.path.basename(path)
        self.file = []
        self.num = 0
        if "note.txt" not in os.listdir(path):
            print(123456)
            for file in os.listdir(path):
                if file[-3:] == 'png':
                    self.file.append(Photo(file, path))
                    self.num += 1
        else:
            note = open(os.path.join(path, "note.txt"), 'r')
            for line in note.readlines():
                width = int(line.split("\t")[1].split(",")[0])
                height = int(line.split("\t")[1].split(",")[1])
                self.file.append(Photo(os.path.join(path, line.split("\t")[0]), path, width, height))
                self.num += 1
            note.close()

    def __repr__(self):
        return self.name

    def creat_config(self):
        """
        create config file for each folder under main folder.
        """
        c = os.path.join(self.path, 'config.xml')
        config = open(c, 'w')
        for i in ['<record>\n', '\t<!-- resource manager options -->\n',
                  '\n', '\t<!-- dont preload anything in this folder -->\n',
                  '\t<boolean id="preload" value="false"/>\n', '\n',
                  '\t<!-- turn off auto mapping -->\n',
                  '\t<boolean id="amap" value="false"/>\n', '\n',
                  '\t<!-- logo mappings -->\n', '\t<!-- the following XML maps '
                                                'pictures inside this folder '
                                                'into other positions\n',
                  '\t\t\t in the resource system, which allows this folder to'
                  ' be dropped into any\n', '\t\t\t place in the graphics '
                                            'folder and still have the'
                                            ' game pick up the graphics\n',
                  '\t\t\t files from the correct places\n',
                  '\t-->\n', '\n', '\t<list id="maps">\n',
                  '\t\t<!-- Auto generated by Mingren Chen -->\n']:
            config.writelines(i)
        for photo in self.file:
            write_stuff = '\t\t<record from="0" to="graphics' \
                          '/pictures/person/0/portrait"/>\n'
            write_list = write_stuff.split("/")
            write_list[-3] = photo.id_
            write_stuff = '/'.join(write_list)
            write_list = write_stuff.split("\"")
            write_list[1] = photo.id_
            config.writelines('\"'.join(write_list))
        config.writelines('/'.join(['\t</list>\n', '</record>']))
        config.close()

    def write_txt(self):
        """
        write a txt file include the name of all photo.
        :return: None
        :rtype: None
        """
        if not os.path.isfile(os.path.join(self.path, 'note.txt')):
            c = os.path.join(self.path, 'note.txt')
            note = open(c, 'w')
            for i in self.file:
                note.write(i.name)
                note.write("\t{},{}".format(i.width, i.height))
                note.write("\n")
            note.close()

    def include(self, photo):
        """
        return if a photo is in the folder.
        :param photo: a photo's name
        :type photo: Photo
        :return: None
        :rtype: None
        """
        if not os.path.isfile(os.path.join(self.path, 'note.txt')):
            self.write_txt()
        else:
            c = os.path.join(self.path, 'note.txt')
            note = open(c, 'r')
            photo_list = note.readlines()
            print(photo_list)
